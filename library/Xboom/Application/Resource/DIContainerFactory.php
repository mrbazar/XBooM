<?php

namespace Xboom\Application\Resource;
/**
 * Resource for initializing dependency injection container
 *
 * @package    Xboom
 * @subpackage Application_Resources
 *
 * @author     yugeon
 * @version    SVN: $Id$
 */
class DIContainerFactory
{

    /**
     * Contains the options for the factory.
     * @var array
     */
    protected  $_options;

    /**
     * Construct a factory that created containers for Zend_Bootstrap
     * based on the Symfony DI framework component.
     *
     * @param array $options Options for factory
     */
    public function __construct(array $options = array())
    {
        $this->_options = $options;
        /**
         * Must manually require here because the autoloader does not
         * (yet) know how to find this.
         */
        require_once 'Symfony/Components/DependencyInjection/sfServiceContainerAutoloader.php';
        \sfServiceContainerAutoloader::register();
    }

    public function setOptions(array $options = array())
    {
        $this->_options = array_merge($this->_options, $options);
    }

    /**
     * @return sfServiceContainerInterface The container
     */
    public function makeContainer()
    {
        $isGenerateDumpFile = $this->_options['enableAutogenerateDumpFile'];
        if (!$isGenerateDumpFile && file_exists($this->_options['dumpFilePath']))
        {
            require_once $this->_options['dumpFilePath'];
            $sc = new $this->_options['dumpFileClass']();
        }
        else
        {
            $sc = $this->buildServiceContainer();
            $this->dumpToFile($sc);
        }

        return $sc;
    }

    /**
     * Build the service container dynamically
     *
     * @return sfServiceContainer
     */
    protected function buildServiceContainer()
    {
        //
        $sc = new \sfServiceContainerBuilder();
        $file = $this->_options['configFile'];
        $suffix = strtolower(pathinfo($file, PATHINFO_EXTENSION));
        switch ($suffix)
        {
            case 'xml':
                $loader = new \sfServiceContainerLoaderFileXml($sc);
                break;

            default:
                throw new \Zend_Exception("Invalid configuration file provided; unknown config type '$suffix'");
        }
        $loader->load($file);

        return $sc;
    }

    /**
     * Dump current service container to file.
     *
     * @param sfServiceContainer $sc
     */
    protected function dumpToFile($sc)
    {
        $dumper = new \sfServiceContainerDumperPhp($sc);
        $filename = $this->_options['dumpFilePath'];
        if (file_exists($filename))
        {
            // try delete file for rewrite
            unlink($filename);
        }
        file_put_contents($filename,
                $dumper->dump(array('class' => $this->_options['dumpFileClass']))
        );
    }
}